<Window x:Class="UniversalPressureController.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Mensor CPC Controller" Height="800" Width="1200"
        WindowStartupLocation="CenterScreen">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="200"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <ToolBar Grid.Row="0" Height="40">
            <Button Command="{Binding ConnectCommand}" Padding="10,5">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="ðŸ”Œ" FontSize="16" Margin="0,0,5,0"/>
                    <TextBlock Text="Verbinden"/>
                </StackPanel>
            </Button>
            <Button Command="{Binding DisconnectCommand}" Padding="10,5">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="âŒ" FontSize="16" Margin="0,0,5,0"/>
                    <TextBlock Text="Trennen"/>
                </StackPanel>
            </Button>
            <Separator/>
            <TextBlock Text="GPIB-Adresse:" VerticalAlignment="Center" Margin="10,0,5,0"/>
            <TextBox Text="{Binding GpibAddress}" Width="150" VerticalAlignment="Center"/>
            <Separator/>
            <Button Command="{Binding LoadConfigCommand}" Content="ðŸ“ Konfig laden" Padding="10,5"/>
            <Button Command="{Binding SaveConfigCommand}" Content="ðŸ’¾ Konfig speichern" Padding="10,5"/>
            <Separator/>
            <TextBlock Text="Status:" VerticalAlignment="Center" Margin="10,0,5,0"/>
            <TextBlock Text="{Binding StatusMessage}" VerticalAlignment="Center" FontWeight="Bold"
                      Foreground="{Binding IsConnected, Converter={StaticResource BoolToColorConverter}}"/>
        </ToolBar>

        <ScrollViewer Grid.Row="1" Margin="10">
            <ItemsControl ItemsSource="{Binding Channels}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel Orientation="Horizontal"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Border BorderBrush="LightGray" BorderThickness="1" 
                                CornerRadius="5" Margin="5" Width="280">
                            <Grid Margin="10">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <Grid Grid.Row="0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="{Binding Name}" FontSize="16" FontWeight="Bold"/>
                                    <Ellipse Grid.Column="1" Width="15" Height="15"
                                            Fill="{Binding Status, Converter={StaticResource StatusToColorConverter}}"/>
                                </Grid>

                                <StackPanel Grid.Row="1" Margin="0,10,0,5">
                                    <TextBlock Text="Istwert:" FontSize="12" Foreground="Gray"/>
                                    <TextBlock FontSize="24" FontWeight="Bold">
                                        <TextBlock.Text>
                                            <MultiBinding StringFormat="{}{0:F3} {1}">
                                                <Binding Path="ActualValue"/>
                                                <Binding Path="Unit"/>
                                            </MultiBinding>
                                        </TextBlock.Text>
                                    </TextBlock>
                                </StackPanel>

                                <Grid Grid.Row="2" Margin="0,5">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Sollwert:" VerticalAlignment="Center" Margin="0,0,10,0"/>
                                    <TextBox Grid.Column="1" Text="{Binding Setpoint, StringFormat=F3}" 
                                            VerticalAlignment="Center" FontSize="14"/>
                                    <TextBlock Grid.Column="2" Text="{Binding Unit}" 
                                              VerticalAlignment="Center" Margin="5,0,0,0"/>
                                </Grid>

                                <TextBlock Grid.Row="3" Margin="0,5">
                                    <TextBlock.Text>
                                        <MultiBinding StringFormat="Abweichung: {0:F3} {1}">
                                            <Binding Path="Deviation"/>
                                            <Binding Path="Unit"/>
                                        </MultiBinding>
                                    </TextBlock.Text>
                                </TextBlock>

                                <StackPanel Grid.Row="4" Orientation="Horizontal" Margin="0,10,0,0">
                                    <Button Content="Start" Width="60" Margin="0,0,5,0"
                                           Command="{Binding DataContext.StartChannelCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                           CommandParameter="{Binding}"/>
                                    <Button Content="Stop" Width="60" Margin="0,0,5,0"
                                           Command="{Binding DataContext.StopChannelCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                           CommandParameter="{Binding}"/>
                                    <Button Content="EntlÃ¼ften" Width="70" Margin="0,0,5,0"
                                           Command="{Binding DataContext.VentChannelCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                           CommandParameter="{Binding}"/>
                                    <Button Content="Setzen" Width="60"
                                           Command="{Binding DataContext.SetSetpointCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                           CommandParameter="{Binding}"/>
                                </StackPanel>

                                <TextBlock Grid.Row="5" FontSize="10" Foreground="Gray" Margin="0,5,0,0">
                                    <TextBlock.Text>
                                        <MultiBinding StringFormat="Aktualisiert: {0:HH:mm:ss}">
                                            <Binding Path="LastUpdate"/>
                                        </MultiBinding>
                                    </TextBlock.Text>
                                </TextBlock>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <GroupBox Grid.Row="2" Header="Kommunikationslog" Margin="10,0,10,10">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                <Button Grid.Row="0" Content="Log leeren" HorizontalAlignment="Right" 
                       Command="{Binding ClearLogCommand}" Margin="0,0,0,5"/>
                <ListBox Grid.Row="1" ItemsSource="{Binding LogMessages}" 
                        ScrollViewer.HorizontalScrollBarVisibility="Auto"
                        FontFamily="Consolas" FontSize="11"/>
            </Grid>
        </GroupBox>

        <StatusBar Grid.Row="3">
            <StatusBarItem>
                <TextBlock>
                    <TextBlock.Text>
                        <MultiBinding StringFormat="KanÃ¤le: {0}">
                            <Binding Path="Channels.Count"/>
                        </MultiBinding>
                    </TextBlock.Text>
                </TextBlock>
            </StatusBarItem>
            <Separator/>
            <StatusBarItem>
                <TextBlock Text="{Binding StatusMessage}"/>
            </StatusBarItem>
        </StatusBar>
    </Grid>
</Window>
